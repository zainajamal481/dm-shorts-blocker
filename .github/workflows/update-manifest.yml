name: Update Manifest Versions

on:
  push:
    branches: [ main ]
    paths:
      - 'manifest*.json'

jobs:
  update-version:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'chore: update version')"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Update version in manifest files
      run: |
        # Get current version from manifest.json
        CURRENT_VERSION=$(node -p "require('./manifest.json').version")
        echo "Current version: $CURRENT_VERSION"
        
        # Extract major, minor, patch
        IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
        
        # Increment patch version
        NEW_PATCH=$((PATCH + 1))
        NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
        echo "New version: $NEW_VERSION"
        
        # Update manifest.json
        node -e "
          const fs = require('fs');
          const manifest = JSON.parse(fs.readFileSync('./manifest.json', 'utf8'));
          manifest.version = '$NEW_VERSION';
          fs.writeFileSync('./manifest.json', JSON.stringify(manifest, null, 2));
        "
        
        # Update manifest-firefox.json if it exists
        if [ -f manifest-firefox.json ]; then
          node -e "
            const fs = require('fs');
            const manifest = JSON.parse(fs.readFileSync('./manifest-firefox.json', 'utf8'));
            manifest.version = '$NEW_VERSION';
            fs.writeFileSync('./manifest-firefox.json', JSON.stringify(manifest, null, 2));
          "
        fi
        
        # Update manifest-firefox-simple.json if it exists
        if [ -f manifest-firefox-simple.json ]; then
          node -e "
            const fs = require('fs');
            const manifest = JSON.parse(fs.readFileSync('./manifest-firefox-simple.json', 'utf8'));
            manifest.version = '$NEW_VERSION';
            fs.writeFileSync('./manifest-firefox-simple.json', JSON.stringify(manifest, null, 2));
          "
        fi

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add manifest*.json
        git commit -m "chore: update version to $NEW_VERSION" || exit 0
        git push
