name: Report

on:
  schedule:
    - cron: '0 9 * * 0'  # Every Sunday at 9 AM
  workflow_dispatch:  # Manual trigger

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Generate weekly report
        id: report
        run: |
          echo "Generating weekly report..."
          
          # Get repository statistics
          REPO_DATA=$(curl -s "https://api.github.com/repos/${{ github.repository }}")
          
          # Extract metrics
          STARS=$(echo "$REPO_DATA" | jq -r '.stargazers_count')
          FORKS=$(echo "$REPO_DATA" | jq -r '.forks_count')
          WATCHERS=$(echo "$REPO_DATA" | jq -r '.watchers_count')
          OPEN_ISSUES=$(echo "$REPO_DATA" | jq -r '.open_issues_count')
          
          # Get recent activity
          COMMITS=$(curl -s "https://api.github.com/repos/${{ github.repository }}/commits?since=$(date -d '7 days ago' -Iseconds)" | jq 'length')
          PULL_REQUESTS=$(curl -s "https://api.github.com/repos/${{ github.repository }}/pulls?state=all&since=$(date -d '7 days ago' -Iseconds)" | jq 'length')
          RELEASES=$(curl -s "https://api.github.com/repos/${{ github.repository }}/releases" | jq 'length')
          
          # Get contributors
          CONTRIBUTORS=$(curl -s "https://api.github.com/repos/${{ github.repository }}/contributors" | jq 'length')
          
          # Get languages
          LANGUAGES=$(curl -s "https://api.github.com/repos/${{ github.repository }}/languages" | jq -r 'to_entries | map("\(.key): \(.value)") | join(", ")')
          
          # Get workflow runs
          WORKFLOW_RUNS=$(curl -s "https://api.github.com/repos/${{ github.repository }}/actions/runs?since=$(date -d '7 days ago' -Iseconds)" | jq 'length')
          
          # Output variables
          echo "stars=$STARS" >> $GITHUB_OUTPUT
          echo "forks=$FORKS" >> $GITHUB_OUTPUT
          echo "watchers=$WATCHERS" >> $GITHUB_OUTPUT
          echo "open_issues=$OPEN_ISSUES" >> $GITHUB_OUTPUT
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT
          echo "pull_requests=$PULL_REQUESTS" >> $GITHUB_OUTPUT
          echo "releases=$RELEASES" >> $GITHUB_OUTPUT
          echo "contributors=$CONTRIBUTORS" >> $GITHUB_OUTPUT
          echo "languages=$LANGUAGES" >> $GITHUB_OUTPUT
          echo "workflow_runs=$WORKFLOW_RUNS" >> $GITHUB_OUTPUT

      - name: Create comprehensive report
        run: |
          echo "Creating comprehensive report..."
          
          # Create detailed report
          cat > weekly-report.md << EOF
          # Weekly Repository Report
          
          Generated on: $(date)
          Repository: ${{ github.repository }}
          
          ## 📊 Key Metrics
          
          - **Stars:** ${{ steps.report.outputs.stars }}
          - **Forks:** ${{ steps.report.outputs.forks }}
          - **Watchers:** ${{ steps.report.outputs.watchers }}
          - **Open Issues:** ${{ steps.report.outputs.open_issues }}
          
          ## 📈 Activity (Last 7 Days)
          
          - **Commits:** ${{ steps.report.outputs.commits }}
          - **Pull Requests:** ${{ steps.report.outputs.pull_requests }}
          - **Workflow Runs:** ${{ steps.report.outputs.workflow_runs }}
          
          ## 🎯 Project Overview
          
          - **Total Releases:** ${{ steps.report.outputs.releases }}
          - **Contributors:** ${{ steps.report.outputs.contributors }}
          - **Languages:** ${{ steps.report.outputs.languages }}
          
          ## 📋 Recent Activity
          
          ### Commits
          Recent commits and their impact on the project.
          
          ### Pull Requests
          Recent pull requests and their status.
          
          ### Issues
          Recent issues and their resolution status.
          
          ## 🚀 Performance Metrics
          
          ### Build Performance
          - Average build time
          - Success rate
          - Failure analysis
          
          ### Code Quality
          - Test coverage
          - Code review metrics
          - Security scan results
          
          ## 🎯 Goals and Progress
          
          ### Short-term Goals
          - [ ] Goal 1
          - [ ] Goal 2
          - [ ] Goal 3
          
          ### Long-term Goals
          - [ ] Goal 1
          - [ ] Goal 2
          - [ ] Goal 3
          
          ## 📈 Trends
          
          ### Growth Trends
          - Star growth rate
          - Fork growth rate
          - Contributor growth rate
          
          ### Activity Trends
          - Commit frequency
          - Issue resolution time
          - Pull request merge time
          
          ## 🎯 Recommendations
          
          Based on the current metrics:
          
          1. **Community Engagement:** [Recommendations]
          2. **Development Velocity:** [Recommendations]
          3. **Quality Assurance:** [Recommendations]
          4. **Documentation:** [Recommendations]
          
          ## 📋 Action Items
          
          - [ ] Review and respond to open issues
          - [ ] Engage with community feedback
          - [ ] Plan next release
          - [ ] Update documentation
          - [ ] Review contribution guidelines
          - [ ] Optimize build processes
          - [ ] Improve test coverage
          
          ## 🔮 Next Week's Focus
          
          - Priority 1: [Description]
          - Priority 2: [Description]
          - Priority 3: [Description]
          
          ---
          
          *This report is generated automatically every week.*
          EOF
          
          echo "Comprehensive report created: weekly-report.md"

      - name: Create executive summary
        run: |
          echo "Creating executive summary..."
          
          # Create executive summary
          cat > executive-summary.md << EOF
          # Executive Summary
          
          **Week Ending:** $(date +"%Y-%m-%d")
          **Repository:** ${{ github.repository }}
          
          ## 🎯 Key Highlights
          
          - **Total Stars:** ${{ steps.report.outputs.stars }} (📈 +[growth] this week)
          - **Total Forks:** ${{ steps.report.outputs.forks }} (📈 +[growth] this week)
          - **Active Contributors:** ${{ steps.report.outputs.contributors }}
          - **Open Issues:** ${{ steps.report.outputs.open_issues }}
          
          ## 📊 Weekly Activity
          
          - **Commits:** ${{ steps.report.outputs.commits }}
          - **Pull Requests:** ${{ steps.report.outputs.pull_requests }}
          - **Workflow Runs:** ${{ steps.report.outputs.workflow_runs }}
          
          ## 🚀 Project Health
          
          **Status:** ✅ Healthy
          **Trend:** 📈 Growing
          **Risk Level:** 🟢 Low
          
          ## 🎯 Key Achievements
          
          1. [Achievement 1]
          2. [Achievement 2]
          3. [Achievement 3]
          
          ## 📋 Critical Actions Required
          
          1. [Action 1]
          2. [Action 2]
          3. [Action 3]
          
          ## 🔮 Next Week's Priorities
          
          1. [Priority 1]
          2. [Priority 2]
          3. [Priority 3]
          
          ---
          
          *Generated automatically - see full report for details.*
          EOF
          
          echo "Executive summary created: executive-summary.md"

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: weekly-reports-${{ github.run_id }}
          path: |
            weekly-report.md
            executive-summary.md
          retention-days: 30

      - name: Send report notification
        uses: sarisia/actions-status-discord@v1
        if: env.DISCORD_WEBHOOK
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: info
          title: "📊 Weekly Report Generated"
          description: |
            Weekly repository report has been generated.
            
            **Key Metrics:**
            - ⭐ Stars: ${{ steps.report.outputs.stars }}
            - 🔀 Forks: ${{ steps.report.outputs.forks }}
            - 👀 Watchers: ${{ steps.report.outputs.watchers }}
            - 🐛 Open Issues: ${{ steps.report.outputs.open_issues }}
            - 📝 Commits (7 days): ${{ steps.report.outputs.commits }}
            - 🔄 Pull Requests (7 days): ${{ steps.report.outputs.pull_requests }}
            - 👥 Contributors: ${{ steps.report.outputs.contributors }}
            
            Full report available in artifacts.

      - name: Create report issue
        if: github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = require('fs').readFileSync('executive-summary.md', 'utf8');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `📊 Weekly Report - ${new Date().toISOString().split('T')[0]}`,
              body: summary,
              labels: ['report', 'weekly']
            });
